<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>formulario nvocusaf</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        :root {
            --primary: #2E7D32;
            --secondary: #4CAF50;
            --light: #E8F5E9;
            --dark: #1B5E20;
            --accent: #8BC34A;
            --warning: #FFC107;
            --danger: #F44336;
            --gray: #757575;
            --light-gray: #F5F5F5;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f0f2f5;
        }
        
        .container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: 250px;
            background-color: var(--dark);
            color: white;
            padding-top: 20px;
        }
        
        .sidebar-header {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
        }
        
        .sidebar-header h2 {
            font-size: 20px;
            font-weight: 600;
        }
        
        .nav-menu {
            list-style: none;
        }
        
        .nav-item {
            margin-bottom: 5px;
        }
        
        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.3s;
            gap: 10px;
        }
        
        .nav-link:hover, .nav-link.active {
            background-color: var(--primary);
            color: white;
        }
        
        .nav-link i {
            width: 20px;
            text-align: center;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .page-title {
            font-size: 24px;
            color: var(--dark);
        }
        
        .breadcrumb {
            display: flex;
            list-style: none;
            background-color: #fff;
            padding: 8px 16px;
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .breadcrumb-item {
            display: flex;
            align-items: center;
        }
        
        .breadcrumb-item + .breadcrumb-item::before {
            content: "/";
            padding: 0 8px;
            color: var(--gray);
        }
        
        .breadcrumb-item a {
            color: var(--primary);
            text-decoration: none;
        }
        
        .breadcrumb-item.active {
            color: var(--gray);
        }
        
        /* Cards */
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .card-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-title {
            font-size: 18px;
            color: var(--dark);
            margin: 0;
        }
        
        .card-body {
            padding: 20px;
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 15px;
        }
        
     .process-steps {
      display: flex;
      justify-content: space-between;
      margin-bottom: 25px;
      position: relative;
    }
    
    .process-steps::before {
      content: "";
      position: absolute;
      top: 15px;
      left: 0;
      right: 0;
      height: 2px;
      background-color: #ddd;
      z-index: 1;
    }
    
    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 2;
      flex: 1;
    }
    
    .step-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background-color: white;
      border: 2px solid #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 8px;
      color: var(--gray);
      font-weight: bold;
    }
    
    .step.active .step-icon {
      background-color: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    
    .step.completed .step-icon {
      background-color: var(--secondary);
      border-color: var(--secondary);
      color: white;
    }
    
    .step-title {
      font-size: 12px;
      color: var(--gray);
      text-align: center;
    }
    
    .step.active .step-title {
      color: var(--primary);
      font-weight: 500;
    }
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(46, 125, 50, 0.2);
        }
        
        .form-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background-color: white;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin-right: -10px;
            margin-left: -10px;
        }
        
        .form-col {
            padding-right: 10px;
            padding-left: 10px;
            flex: 1;
        }
        
        .form-col-6 {
            flex: 0 0 50%;
            max-width: 50%;
        }
        
        .form-col-4 {
            flex: 0 0 33.33%;
            max-width: 33.33%;
        }
        
        /* Buttons */
        .btn {
            display: inline-block;
            padding: 10px 16px;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            text-decoration: none;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--dark);
        }
        
        .btn-secondary {
            background-color: var(--gray);
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #616161;
        }
        
        .btn-success {
            background-color: var(--secondary);
            color: white;
        }
        
        .btn-warning {
            background-color: var(--warning);
            color: white;
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
            overflow-x: auto;
        }
        
        .tab-item {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .tab-item.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
            font-weight: 500;
        }
        
        /* File Upload */
        .file-upload {
            display: flex;
            align-items: center;
        }
        
        .file-upload-btn {
            margin-right: 10px;
        }
        
        .file-name {
            font-size: 14px;
            color: var(--gray);
        }
        
        /* Map Container */
        .map-container {
            height: 400px;
            background-color: #eee;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray);
            margin-bottom: 15px;
            position: relative;
        }
        
        /* Map Controls */
        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 5px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 8px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .map-controls button {
            background-color: black;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }
        
        .map-controls button:hover {
            background-color: var(--light);
            transform: translateY(-1px);
        }
        
        .map-controls button i {
            font-size: 14px;
        }
        
        .map-controls button.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .map-controls button.active i {
            color: white;
        }
        
        .map-controls button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Tables */
        .table-responsive {
            overflow-x: auto;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th, .table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .table thead th {
            background-color: var(--light);
            color: var(--primary);
            font-weight: 600;
        }
        
        .table tbody tr:hover {
            background-color: rgba(0,0,0,0.02);
        }
        
        /* Action buttons */
        .action-btns {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* Floating button */
        .floating-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background-color: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: all 0.3s;
            z-index: 100;
        }
        
        .alert {
            padding: 12px 16px;
            border-radius: 4px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        
        .alert-info {
            background-color: #E3F2FD;
            color: #0D47A1;
            border-left: 4px solid #2196F3;
        }
        
        .alert-warning {
            background-color: #FFF8E1;
            color: #FF6F00;
            border-left: 4px solid #FFC107;
        }
        
        .alert i {
            margin-right: 10px;
            font-size: 18px;
        }
        
        .floating-btn:hover {
            background-color: var(--dark);
            transform: scale(1.05);
        }
        
        .floating-btn i {
            font-size: 24px;
        }
        
        /* Tooltip */
        .floating-btn .tooltip {
            position: absolute;
            top: -40px;
            right: 0;
            background-color: rgba(0,0,0,0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
            white-space: nowrap;
        }
        
        .floating-btn:hover .tooltip {
            opacity: 1;
        }
        
        h1 {
            text-align: center;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        table, th, td {
            border: 1px solid #ddd;
        }
        
        th, td {
            padding: 10px;
            text-align: left;
        }
        
        th {
            background-color: #f2f2f2;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        input[type="radio"],
        input[type="checkbox"] {
            margin-right: 5px;
        }
        
        .inline-radio {
            display: inline-block;
            margin-right: 15px;
        }
        
        .footer {
            margin-top: 30px;
            text-align: center;
        }
        
        .signatures {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 30px;
        }
        
        .signature-box {
            border-top: 1px solid #000;
            padding-top: 5px;
            text-align: center;
        }
        
        .coord-table input {
            width: 100%;
        }
        
        .coordinate-group {
            display: flex;
            gap: 10px;
        }
        
        .coordinate-group input {
            flex: 1;
        }
        
        button {
            background-color: #2c5282;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        
        button:hover {
            background-color: #1a365d;
        }
        
        .action-btn {
            background-color: #4CAF50;
            margin-left: 5px;
            padding: 4px 6px;
            font-size: 12px;
            min-width: 30px;
        }
        
        .action-btn.delete {
            background-color: #f44336;
        }
        
        .row {
            display: flex;
            gap: 15px;
        }
        
        .col {
            flex: 1;
        }
        
        #map {
            height: 100%;
            width: 100%;
            border-radius: 4px;
        }
        
        .vertex-actions {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .vertex-table-container {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        #vertices-table {
            width: 100%;
            margin: 0;
        }
        
        #vertices-table th, 
        #vertices-table td {
            padding: 8px 10px;
            font-size: 13px;
        }
        
        #vertices-table thead th {
            position: sticky;
            top: 0;
            background-color: var(--light);
            z-index: 10;
        }
        
        .vertex-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .calculated-area {
            font-weight: bold;
            color: var(--primary);
        }
        
        /* Division styles */
        .division-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary);
        }
        
        .division-title {
            font-weight: bold;
            color: var(--dark);
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
        }
        
        .division-actions {
            display: flex;
            gap: 5px;
        }
        
        .division-btn {
            padding: 3px 8px;
            font-size: 12px;
            border-radius: 3px;
        }
        
        .division-btn.edit {
            background-color: var(--warning);
            color: #000;
        }
        
        .division-btn.delete {
            background-color: var(--danger);
            color: white;
        }
        
        .division-btn.add {
            background-color: var(--secondary);
            color: white;
        }
        
        /* Vertex types */
        .vertex-type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .vertex-type-btn {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
            font-size: 12px;
        }
        
        .vertex-type-btn.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        @media print {
            body {
                background-color: white;
            }
            
            .container {
                box-shadow: none;
            }
            
            button {
                display: none;
            }
            
            .map-controls {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">
              <i class="fas fa-leaf"></i>
              <h3>SISTEMA CUSAF</h3>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                  <a href="index.html" class="nav-link">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Inicio</span>
                  </a>
                </li>
                <li class="nav-item ">
                  <a href="prime.html" class="nav-link">
                    <i class="fas fa-map-marked-alt"></i>
                    <span>Registro Áreas Potenciales</span>
                  </a>
                </li>
                        
                  <a href="beneficiarios.html" class="nav-link active" onclick="toggleSubmenu('beneficiarios-menu')">
                    <i class="fas fa-users"></i>
                    <span>Registro Potenciales Beneficiarios</span>
                  </a>
                           
                                 
              </ul>
          </div>
        
        <div class="main-content">
            <div class="card">
                <div class="card-body">
                    <div class="process-steps">
                        <div class="step active">
                            <div class="step-icon"><i class="fas fa-male"></i></div>
                            <div class="step-title">Presentación posibles Beneficiarios</div>
                        </div>
                        <div class="step active">
                            <div class="step-icon"><i class="fas fa-tree"></i></div>
                            <div class="step-title">Trabajo de Campo</div>
                        </div>
                        <div class="step">
                            <div class="step-icon"><i class="fas fa-pencil"></i></div>
                            <div class="step-title">Elaboración del informe Tecnico</div>
                        </div>
                        <div class="step">
                            <div class="step-icon"><i class="fas fa-check"></i></div>
                            <div class="step-title">Otorgamiento del Derecho</div>
                        </div>
                        <div class="step">
                            <div class="step-icon"><i class="fas fa-gavel"></i></div>
                            <div class="step-title">Recursos Administrativos</div>
                        </div>
                        <div class="step">
                            <div class="step-icon"><i class="fas fa-handshake"></i></div>
                            <div class="step-title">Suscripcion del contrato</div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        Complete toda la información solicitada. Los campos marcados con (*) son obligatorios.
                    </div>
                </div>
            </div>
            
            <div id="tab1" class="tab-content active">
                <form id="beneficiario-form">
                    <div class="card">
            <div class="tabs" id="formTabs">
            <a href="potencialesbeneficiarios_campo.html" class="tab-item active">
              <i class="fa-solid fa-person-walking-arrow-right"></i> Información trabajo de campo
            </a>
            <a href="potencialesbeneficiarios_estado.html" class="tab-item">
              <i class="fa-solid fa-person-arrow-down-to-line"></i> Estados del Área
            </a>
            <a href="potencialesbeneficiarios_division.html" class="tab-item">
              <i class="fas fa-map-marked-alt"></i> Ubicación del predio
            </a>
            <a href="potencialesbeneficiarios_documentos.html" class="tab-item">
              <i class="fas fa-file"></i> Presentación documental
            </a>
          </div>
                        
                        <div class="card-header">
                            <h3 class="card-title">División del Área Potencial</h3>
                        </div>
                        
                        <div class="card-body">
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label required">Código Área Potencial</label>
                                        <select class="form-control" name="codigoArea" id="codigoArea">
                                            <option value="">Seleccione</option>
                                            <option value="cod10001-AP">cod10001-AP</option>
                                            <option value="cod10002-AP">cod10002-AP</option>
                                            <option value="cod20002-AP">cod20002-AP</option>
                                            <option value="cod30004-AP">cod30004-AP</option>
                                            <option value="cod40001-AP">cod40001-AP</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label required"> Departamento</label>
                                        <select class="form-control" name="departamento" id="departamento">
                                            <option value="">Seleccione</option>
                                            <option value="Huanuco">Huanuco</option>
                                            <option value="Ucayali">Ucayali</option>
                                            <option value="Pasco">Pasco</option>
                                            <option value="Madre de Dios">Madre de Dios</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label required">Provincia</label>
                                        <select class="form-control" name="provincia" id="provincia">
                                            <option value="">Seleccione</option>
                                            <option value="Puerto Inca">Puerto Inca</option>
                                            <option value="Coronel Portillo">Coronel Portillo</option>
                                            <option value="Oxapampa">Oxapampa</option>
                                            <option value="Tambopata">Tambopata</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label required">Distrito</label>
                                        <select class="form-control" name="distrito" id="distrito">
                                            <option value="">Seleccione</option>
                                            <option value="Honoria">Honoria</option>
                                            <option value="Callería">Callería</option>
                                            <option value="Puerto Bermúdez">Puerto Bermúdez</option>
                                            <option value="Inambari">Inambari</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label">Centro Poblado</label>
                                        <select class="form-control" id="centroPoblado">
                                            <option value="">Seleccionar centro poblado</option>
                                            <option value="Centro 1">Centro Poblado 1</option>
                                            <option value="Centro 2">Centro Poblado 2</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-col">
                                    <div class="form-group">
                                        <label class="form-label">Bloque</label>
                                        <select class="form-control" id="bloque">
                                            <option value="">Seleccionar bloque</option>
                                            <option value="I">I</option>
                                            <option value="II">II</option>
                                            <option value="III">III</option>
                                            <option value="IV">IV</option>
                                            <option value="V">V</option>
                                            <option value="VI">VI</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Division Information -->
                            <div id="divisions-container">
                                <!-- Divisions will be added here dynamically -->
                            </div>
                            
                            <!-- Add Division Button -->
                            <div class="form-group">
                                <button type="button" id="add-division-btn" class="btn btn-primary">
                                    <i class="fas fa-plus"></i> Agregar ubicación Geografica
                                </button>
                            </div>
                            
                            <!-- Map Container -->
                            <div class="map-container">
                                <div id="map"></div>
                                <div class="map-controls">
                                    <button id="draw-polygon-btn" title="Dibujar polígono">
                                        <i class="fas fa-draw-polygon"></i> Polígono
                                    </button>
                                    <button id="draw-marker-btn" title="Añadir vértice interno" disabled>
                                        <i class="fas fa-map-marker-alt"></i> Punto
                                    </button>
                                    <button id="edit-shapes-btn" title="Editar elementos" disabled>
                                        <i class="fas fa-edit"></i> Editar
                                    </button>
                                    <button id="delete-all-btn" title="Borrar todo">
                                        <i class="fas fa-trash"></i> Borrar
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Vertex Info -->
                            <div class="vertex-info">
                                <span>Vértices de límite: <strong id="boundary-count">0</strong></span>
                                <span>Vértices internos: <strong id="internal-count">0</strong></span>
                                <span>Área calculada: <strong id="calculated-area" class="calculated-area">0.00</strong> ha</span>
                            </div>
                            
                            <!-- Vertex Tables -->
                            <div class="vertex-table-container">
                                <table id="vertices-table" class="coord-table">
                                    <thead>
                                        <tr>
                                            <th>Tipo</th>
                                            <th>N°</th>
                                            <th>Este (X)</th>
                                            <th>Norte (Y)</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="vertices-tbody">
                                        <!-- Vertex rows will be added dynamically -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="archivoDocumento" class="required">Archivo de Documento</label>
                                        <input 
                                            type="file" 
                                            id="archivoDocumento" 
                                            name="archivoDocumento" 
                                            accept=".xlxs, svg" 
                                        >
                                        <small>Formato permitido xlxs</small>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <!-- Empty column for alignment -->
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-col" style="text-align: left;">
                                    <a href="potencialesbeneficiarios_estado.html"><button type="button" class="btn btn-secondary">Anterior</button></a>
                                </div>
                                <div class="form-col" style="text-align: right;">
                                    <a href="potencialesbeneficiarios_documentos.html"><button type="button" class="btn btn-primary">Guardar y Siguiente</button></a>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Include Leaflet JS and plugins -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-geometryutil/0.9.1/leaflet.geometryutil.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Datos de áreas potenciales (simulando una base de datos)
            const areasPotenciales = {
                'cod10001-AP': {
                    departamento: 'Huanuco',
                    provincia: 'Puerto Inca',
                    distrito: 'Honoria',
                    coordenadas: [[-9.3, -75.1], [-9.3, -75.0], [-9.2, -75.0], [-9.2, -75.1]],
                    area: 100.50
                },
                'cod10002-AP': {
                    departamento: 'Ucayali',
                    provincia: 'Coronel Portillo',
                    distrito: 'Callería',
                    coordenadas: [[-8.4, -74.6], [-8.4, -74.5], [-8.3, -74.5], [-8.3, -74.6]],
                    area: 85.25
                },
                'cod20002-AP': {
                    departamento: 'Pasco',
                    provincia: 'Oxapampa',
                    distrito: 'Puerto Bermúdez',
                    coordenadas: [[-10.3, -75.2], [-10.3, -75.1], [-10.2, -75.1], [-10.2, -75.2]],
                    area: 120.75
                },
                'cod30004-AP': {
                    departamento: 'Madre de Dios',
                    provincia: 'Tambopata',
                    distrito: 'Inambari',
                    coordenadas: [[-12.6, -69.2], [-12.6, -69.1], [-12.5, -69.1], [-12.5, -69.2]],
                    area: 95.30
                },
                'cod40001-AP': {
                    departamento: 'San Martín',
                    provincia: 'Moyobamba',
                    distrito: 'Calzada',
                    coordenadas: [[-6.1, -76.9], [-6.1, -76.8], [-6.0, -76.8], [-6.0, -76.9]],
                    area: 110.20
                }
            };

            // Initialize the map centered on Peru
            const map = L.map('map').setView([-9.1900, -75.0152], 6);
            
            // Add base map layer (OpenStreetMap)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            // Feature groups to store different types of vertices and divisions
            const drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);
            
            let boundaryVertices = [];
            let internalVertices = [];
            let polygon = null;
            let editMode = false;
            let currentVertexType = 'boundary';
            let divisions = [];
            let currentDivisionId = null;
            let divisionCounter = 1;
            
            // Initialize draw controls
            const drawControl = new L.Control.Draw({
                draw: {
                    polygon: {
                        shapeOptions: {
                            color: '#2E7D32',
                            fillColor: '#2E7D32',
                            fillOpacity: 0.3
                        },
                        allowIntersection: false,
                        showArea: true
                    },
                    polyline: false,
                    rectangle: false,
                    circle: false,
                    marker: {
                        icon: new L.Icon({
                            iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41]
                        })
                    }
                },
                edit: {
                    featureGroup: drawnItems
                }
            });
            
            map.addControl(drawControl);
            
            // Event listener para el cambio de código de área potencial
            document.getElementById('codigoArea').addEventListener('change', function() {
                const codigo = this.value;
                if (codigo && areasPotenciales[codigo]) {
                    const area = areasPotenciales[codigo];
                    
                    // Autocompletar los campos de ubicación
                    document.getElementById('departamento').value = area.departamento;
                    document.getElementById('provincia').value = area.provincia;
                    document.getElementById('distrito').value = area.distrito;
                    
                    // Dibujar el polígono referencial
                    drawnItems.clearLayers();
                    boundaryVertices = [];
                    internalVertices = [];
                    divisions = [];
                    divisionCounter = 1;
                    currentDivisionId = null;
                    document.getElementById('divisions-container').innerHTML = '';
                    
                    const latlngs = area.coordenadas.map(coord => new L.LatLng(coord[0], coord[1]));
                    polygon = L.polygon(latlngs, {
                        color: '#2E7D32',
                        fillColor: '#2E7D32',
                        fillOpacity: 0.3,
                        weight: 3
                    }).addTo(drawnItems);
                    
                    // Centrar el mapa en el polígono
                    map.fitBounds(polygon.getBounds());
                    
                    // Actualizar los vértices de límite
                    boundaryVertices = area.coordenadas.map(coord => ({
                        type: 'boundary',
                        lat: coord[0],
                        lng: coord[1]
                    }));
                    
                    // Calcular área
                    document.getElementById('calculated-area').textContent = area.area.toFixed(2);
                    
                    // Habilitar controles
                    document.getElementById('draw-marker-btn').disabled = false;
                    document.getElementById('edit-shapes-btn').disabled = false;
                    document.getElementById('add-division-btn').disabled = false;
                    
                    // Actualizar tabla
                    updateVertexTables();
                }
            });

            // Add Division Button
            document.getElementById('add-division-btn').addEventListener('click', function() {
                if (!polygon) {
                    alert('Primero seleccione un área potencial');
                    return;
                }
                
                const divisionId = 'div-' + divisionCounter++;
                currentDivisionId = divisionId;
                
                // Add division to the list
                const division = {
                    id: divisionId,
                    code: 'DIV-' + (divisionCounter - 1),
                    vertices: [],
                    area: 0
                };
                
                divisions.push(division);
                updateDivisionsList();
                
                // Enable drawing for this division
                document.getElementById('draw-polygon-btn').disabled = false;
                document.getElementById('draw-marker-btn').disabled = true;
                document.getElementById('edit-shapes-btn').disabled = true;
                
                // Highlight the current division
                highlightDivision(divisionId);
            });
            
            // Function to update the divisions list
            function updateDivisionsList() {
                const container = document.getElementById('divisions-container');
                container.innerHTML = '';
                
                divisions.forEach(division => {
                    const divElement = document.createElement('div');
                    divElement.className = 'division-info';
                    divElement.dataset.divisionId = division.id;
                    
                    divElement.innerHTML = `
                        <div class="division-title">
                            <span>División ${division.code} - Área: ${division.area.toFixed(2)} ha</span>
                            <div class="division-actions">
                                <button class="division-btn edit" data-division-id="${division.id}">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                                <button class="division-btn delete" data-division-id="${division.id}">
                                    <i class="fas fa-trash"></i> Eliminar
                                </button>
                                <button class="division-btn add" data-division-id="${division.id}">
                                    <i class="fas fa-plus"></i> Subdivisión
                                </button>
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(divElement);
                    
                    // Add event listeners to division buttons
                    divElement.querySelector('.division-btn.edit').addEventListener('click', function() {
                        editDivision(this.dataset.divisionId);
                    });
                    
                    divElement.querySelector('.division-btn.delete').addEventListener('click', function() {
                        deleteDivision(this.dataset.divisionId);
                    });
                    
                    divElement.querySelector('.division-btn.add').addEventListener('click', function() {
                        addSubdivision(this.dataset.divisionId);
                    });
                });
            }
            
            // Function to edit a division
            function editDivision(divisionId) {
                currentDivisionId = divisionId;
                const division = divisions.find(d => d.id === divisionId);
                
                if (division) {
                    // Remove existing division layer
                    drawnItems.eachLayer(layer => {
                        if (layer instanceof L.Polygon && layer.divisionId === divisionId) {
                            drawnItems.removeLayer(layer);
                        }
                    });
                    
                    // Enable editing
                    document.getElementById('draw-polygon-btn').disabled = false;
                    document.getElementById('draw-marker-btn').disabled = true;
                    document.getElementById('edit-shapes-btn').disabled = true;
                    
                    // Highlight the division
                    highlightDivision(divisionId);
                }
            }
            
            // Function to delete a division
            function deleteDivision(divisionId) {
                if (confirm('¿Está seguro de eliminar esta división?')) {
                    // Remove from array
                    divisions = divisions.filter(d => d.id !== divisionId);
                    
                    // Remove from map
                    drawnItems.eachLayer(layer => {
                        if (layer instanceof L.Polygon && layer.divisionId === divisionId) {
                            drawnItems.removeLayer(layer);
                        }
                    });
                    
                    // Update UI
                    updateDivisionsList();
                    
                    // If we deleted the current division, reset
                    if (currentDivisionId === divisionId) {
                        currentDivisionId = null;
                    }
                }
            }
            
            // Function to add a subdivision
            function addSubdivision(parentDivisionId) {
                const parentDivision = divisions.find(d => d.id === parentDivisionId);
                
                if (parentDivision) {
                    const divisionId = 'div-' + divisionCounter++;
                    currentDivisionId = divisionId;
                    
                    // Add division to the list
                    const division = {
                        id: divisionId,
                        code: parentDivision.code + '-' + (divisionCounter - 1),
                        parentId: parentDivisionId,
                        vertices: [],
                        area: 0
                    };
                    
                    divisions.push(division);
                    updateDivisionsList();
                    
                    // Enable drawing for this division
                    document.getElementById('draw-polygon-btn').disabled = false;
                    document.getElementById('draw-marker-btn').disabled = true;
                    document.getElementById('edit-shapes-btn').disabled = true;
                    
                    // Highlight the current division
                    highlightDivision(divisionId);
                }
            }
            
            // Function to highlight a division on the map
            function highlightDivision(divisionId) {
                // Reset all divisions to normal style
                drawnItems.eachLayer(layer => {
                    if (layer instanceof L.Polygon && layer.divisionId) {
                        layer.setStyle({
                            color: '#FF5722',
                            fillColor: '#FF5722',
                            fillOpacity: 0.3,
                            weight: 2
                        });
                    }
                });
                
                // Highlight the selected division
                drawnItems.eachLayer(layer => {
                    if (layer instanceof L.Polygon && layer.divisionId === divisionId) {
                        layer.setStyle({
                            color: '#2196F3',
                            fillColor: '#2196F3',
                            fillOpacity: 0.5,
                            weight: 3
                        });
                        map.fitBounds(layer.getBounds());
                    }
                });
                
                // Highlight in the list
                document.querySelectorAll('.division-info').forEach(div => {
                    div.style.borderLeftColor = div.dataset.divisionId === divisionId ? '#2196F3' : '#2E7D32';
                });
            }
            
            // Event listeners for our custom buttons
            document.getElementById('draw-polygon-btn').addEventListener('click', function() {
                if (!currentDivisionId) {
                    alert('Seleccione o cree una división primero');
                    return;
                }
                
                new L.Draw.Polygon(map, drawControl.options.draw.polygon).enable();
                document.getElementById('draw-marker-btn').disabled = true;
                document.getElementById('edit-shapes-btn').disabled = true;
            });
            
            document.getElementById('draw-marker-btn').addEventListener('click', function() {
                new L.Draw.Marker(map, drawControl.options.draw.marker).enable();
                document.getElementById('draw-polygon-btn').disabled = true;
                document.getElementById('edit-shapes-btn').disabled = true;
            });
            
            document.getElementById('edit-shapes-btn').addEventListener('click', function() {
                editMode = !editMode;
                if (editMode) {
                    this.innerHTML = '<i class="fas fa-check"></i> Terminar edición';
                    this.classList.add('active');
                    drawControl._toolbars.edit._modes.edit.handler.enable();
                    document.getElementById('draw-polygon-btn').disabled = true;
                    document.getElementById('draw-marker-btn').disabled = true;
                } else {
                    this.innerHTML = '<i class="fas fa-edit"></i> Editar';
                    this.classList.remove('active');
                    drawControl._toolbars.edit._modes.edit.handler.disable();
                    document.getElementById('draw-polygon-btn').disabled = false;
                    document.getElementById('draw-marker-btn').disabled = polygon === null;
                }
            });
            
            document.getElementById('delete-all-btn').addEventListener('click', function() {
                if (confirm('¿Está seguro de eliminar todos los elementos del mapa?')) {
                    drawnItems.clearLayers();
                    boundaryVertices = [];
                    internalVertices = [];
                    divisions = [];
                    divisionCounter = 1;
                    currentDivisionId = null;
                    polygon = null;
                    updateVertexTables();
                    updateDivisionsList();
                    document.getElementById('draw-marker-btn').disabled = true;
                    document.getElementById('edit-shapes-btn').disabled = true;
                    document.getElementById('add-division-btn').disabled = true;
                    document.getElementById('calculated-area').textContent = '0.00';
                }
            });
            
            // Map events
            map.on(L.Draw.Event.CREATED, function(e) {
                const layer = e.layer;
                const type = e.layerType;
                
                if (type === 'polygon') {
                    // Handle polygon creation for divisions
                    if (currentDivisionId) {
                        const division = divisions.find(d => d.id === currentDivisionId);
                        if (division) {
                            // Set division properties on the layer
                            layer.divisionId = currentDivisionId;
                            layer.setStyle({
                                color: '#FF5722',
                                fillColor: '#FF5722',
                                fillOpacity: 0.3,
                                weight: 2
                            });
                            
                            // Save vertices to division
                            division.vertices = layer.getLatLngs()[0].map(latlng => ({
                                lat: latlng.lat,
                                lng: latlng.lng
                            }));
                            
                            // Calculate area
                            const area = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]);
                            division.area = area / 10000; // Convert to hectares
                            
                            // Update division list
                            updateDivisionsList();
                        }
                    } else {
                        // Handle main polygon creation
                        polygon = layer;
                        boundaryVertices = layer.getLatLngs()[0].map(latlng => ({
                            type: 'boundary',
                            lat: latlng.lat,
                            lng: latlng.lng
                        }));
                        
                        // Enable marker and edit buttons now that we have a polygon
                        document.getElementById('draw-marker-btn').disabled = false;
                        document.getElementById('edit-shapes-btn').disabled = false;
                        document.getElementById('add-division-btn').disabled = false;
                        
                        // Calculate area
                        const area = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]);
                        document.getElementById('calculated-area').textContent = (area / 10000).toFixed(2); // Convert to hectares
                    }
                } else if (type === 'marker') {
                    // Handle marker creation
                    const vertex = {
                        type: currentVertexType,
                        lat: layer.getLatLng().lat,
                        lng: layer.getLatLng().lng
                    };
                    
                    if (currentVertexType === 'boundary') {
                        boundaryVertices.push(vertex);
                    } else {
                        internalVertices.push(vertex);
                    }
                    
                    // Customize marker appearance based on type
                    if (currentVertexType === 'internal') {
                        layer.setIcon(new L.Icon({
                            iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            className: 'internal-vertex-marker'
                        }));
                    }
                }
                
                drawnItems.addLayer(layer);
                updateVertexTables();
            });
            
            map.on(L.Draw.Event.EDITED, function(e) {
                const layers = e.layers;
                let updated = false;
                
                layers.eachLayer(function(layer) {
                    if (layer instanceof L.Polygon) {
                        if (layer.divisionId) {
                            // Update division vertices
                            const division = divisions.find(d => d.id === layer.divisionId);
                            if (division) {
                                division.vertices = layer.getLatLngs()[0].map(latlng => ({
                                    lat: latlng.lat,
                                    lng: latlng.lng
                                }));
                                
                                // Recalculate area
                                const area = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]);
                                division.area = area / 10000;
                                updated = true;
                            }
                        } else {
                            // Update boundary vertices if main polygon was edited
                            boundaryVertices = layer.getLatLngs()[0].map(latlng => ({
                                type: 'boundary',
                                lat: latlng.lat,
                                lng: latlng.lng
                            }));
                            
                            // Recalculate area
                            const area = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]);
                            document.getElementById('calculated-area').textContent = (area / 10000).toFixed(2);
                            updated = true;
                        }
                    }
                });
                
                if (updated) {
                    updateVertexTables();
                    updateDivisionsList();
                }
            });
            
            map.on(L.Draw.Event.DELETED, function(e) {
                const layers = e.layers;
                let updated = false;
                
                layers.eachLayer(function(layer) {
                    if (layer === polygon) {
                        // Main polygon was deleted
                        polygon = null;
                        boundaryVertices = [];
                        document.getElementById('draw-marker-btn').disabled = true;
                        document.getElementById('edit-shapes-btn').disabled = true;
                        document.getElementById('add-division-btn').disabled = true;
                        document.getElementById('calculated-area').textContent = '0.00';
                        updated = true;
                    } else if (layer instanceof L.Marker) {
                        // Marker was deleted - remove from appropriate array
                        const latlng = layer.getLatLng();
                        internalVertices = internalVertices.filter(v => 
                            v.lat !== latlng.lat || v.lng !== latlng.lng
                        );
                        boundaryVertices = boundaryVertices.filter(v => 
                            v.lat !== latlng.lat || v.lng !== latlng.lng
                        );
                        updated = true;
                    } else if (layer instanceof L.Polygon && layer.divisionId) {
                        // Division polygon was deleted
                        const divisionId = layer.divisionId;
                        divisions = divisions.filter(d => d.id !== divisionId);
                        
                        // Also remove any child divisions
                        divisions = divisions.filter(d => {
                            if (d.parentId === divisionId) {
                                // Remove child division from map
                                drawnItems.eachLayer(l => {
                                    if (l instanceof L.Polygon && l.divisionId === d.id) {
                                        drawnItems.removeLayer(l);
                                    }
                                });
                                return false;
                            }
                            return true;
                        });
                        
                        if (currentDivisionId === divisionId) {
                            currentDivisionId = null;
                        }
                        
                        updated = true;
                    }
                });
                
                if (updated) {
                    updateVertexTables();
                    updateDivisionsList();
                }
            });
            
            // Function to update the vertex tables
            function updateVertexTables() {
                const tbody = document.getElementById('vertices-tbody');
                tbody.innerHTML = '';
                
                // Add boundary vertices
                boundaryVertices.forEach((vertex, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>Límite</td>
                        <td>${index + 1}</td>
                        <td>${vertex.lng.toFixed(6)}</td>
                        <td>${vertex.lat.toFixed(6)}</td>
                        <td>
                            <button class="action-btn edit-vertex" data-type="boundary" data-index="${index}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete delete-vertex" data-type="boundary" data-index="${index}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                // Add internal vertices
                internalVertices.forEach((vertex, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>Interno</td>
                        <td>${index + 1}</td>
                        <td>${vertex.lng.toFixed(6)}</td>
                        <td>${vertex.lat.toFixed(6)}</td>
                        <td>
                            <button class="action-btn edit-vertex" data-type="internal" data-index="${index}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete delete-vertex" data-type="internal" data-index="${index}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                // Update counts
                document.getElementById('boundary-count').textContent = boundaryVertices.length;
                document.getElementById('internal-count').textContent = internalVertices.length;
                
                // Add event listeners to edit and delete buttons
                document.querySelectorAll('.edit-vertex').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const type = this.dataset.type;
                        const index = parseInt(this.dataset.index);
                        editVertex(type, index);
                    });
                });
                
                document.querySelectorAll('.delete-vertex').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const type = this.dataset.type;
                        const index = parseInt(this.dataset.index);
                        deleteVertex(type, index);
                    });
                });
            }
            
            // Function to edit a vertex
            function editVertex(type, index) {
                const vertices = type === 'boundary' ? boundaryVertices : internalVertices;
                const vertex = vertices[index];
                
                // For simplicity, we'll just focus on the map and highlight the vertex
                // In a real app, you might show a modal or form to edit coordinates
                const marker = findMarkerByLatLng(vertex.lat, vertex.lng);
                if (marker) {
                    map.setView([vertex.lat, vertex.lng], map.getZoom());
                    
                    // Flash the marker to highlight it
                    const originalColor = marker.options.color || '#3388ff';
                    marker.setStyle({color: '#ff0000', fillColor: '#ff0000'});
                    
                    setTimeout(() => {
                        marker.setStyle({color: originalColor, fillColor: originalColor});
                    }, 1000);
                    
                    // Enable edit mode if not already enabled
                    if (!editMode) {
                        document.getElementById('edit-shapes-btn').click();
                    }
                }
            }
            
            // Function to delete a vertex
            function deleteVertex(type, index) {
                if (confirm('¿Está seguro de eliminar este vértice?')) {
                    const vertices = type === 'boundary' ? boundaryVertices : internalVertices;
                    const vertex = vertices[index];
                    
                    // Find and remove the marker from the map
                    const marker = findMarkerByLatLng(vertex.lat, vertex.lng);
                    if (marker) {
                        drawnItems.removeLayer(marker);
                    }
                    
                    // Remove from the appropriate array
                    vertices.splice(index, 1);
                    
                    // If we deleted a boundary vertex, we need to recreate the polygon
                    if (type === 'boundary' && polygon) {
                        drawnItems.removeLayer(polygon);
                        
                        if (boundaryVertices.length >= 3) {
                            const latlngs = boundaryVertices.map(v => new L.LatLng(v.lat, v.lng));
                            polygon = L.polygon(latlngs, {
                                color: '#2E7D32',
                                fillColor: '#2E7D32',
                                fillOpacity: 0.3
                            }).addTo(drawnItems);
                            
                            // Recalculate area
                            const area = L.GeometryUtil.geodesicArea(latlngs);
                            document.getElementById('calculated-area').textContent = (area / 10000).toFixed(2);
                        } else {
                            polygon = null;
                            document.getElementById('draw-marker-btn').disabled = true;
                            document.getElementById('edit-shapes-btn').disabled = true;
                            document.getElementById('add-division-btn').disabled = true;
                            document.getElementById('calculated-area').textContent = '0.00';
                        }
                    }
                    
                    updateVertexTables();
                }
            }
            
            // Helper function to find a marker by its LatLng
            function findMarkerByLatLng(lat, lng) {
                let foundMarker = null;
                
                drawnItems.eachLayer(layer => {
                    if (layer instanceof L.Marker) {
                        const markerLatLng = layer.getLatLng();
                        if (markerLatLng.lat === lat && markerLatLng.lng === lng) {
                            foundMarker = layer;
                        }
                    }
                });
                
                return foundMarker;
            }
            
            // Initialize the vertex tables
            updateVertexTables();
        });
    </script>
</body>
</html>
